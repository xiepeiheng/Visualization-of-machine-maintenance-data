# 维修数据可视化项目

## 要求

**功能要求**

维修管理人员可以添加故障种类

可以通过网页进行数据录入工作（使用下拉表格的形式）

通过网页查看可视化效果

**图表要求**

选择日期，以表格的形式查看当日的数据

选择机组，以表格的形式查看当日数据

选择损坏部件种类，以表格的形式查看过往三十天和总数据

选择机组，以表格的形式查看过往三十天和总数据

选择三十天或者全部日期，查看所有数据

各产线当天或者以往某天的故障时间段

## 故障表设计

故障记录表

| 字段名称     | 字段类型 |
| ------------ | -------- |
| 日期         | text     |
| 生产线       | text     |
| 工序         | text     |
| 设备         | text     |
| 故障部位     | text     |
| 是否停车     | text     |
| 开始时间     | text     |
| 结束时间     | text     |
| 停车时长     | num      |
| 故障描述     | text     |
| 故障原因     | num      |
| 故障处理结果 | text     |
| 维修部门     | text     |

## 页面设计

### 停机表页面布局

**选择时间段区域** 

在六个方格中分别输入起止年月日

**数据区域1：各机组的五种数据累加的列表（表格形式）**

采用列表的形式，分为五列。机组，维修（机修，自修，电修），待料，换辊，开机时间

```sqlite
select 机组,CAST(sum(机修)+sum(电修)+sum(自修) as int),cast(sum(换辊) as int),cast(sum(待料) as int) from down GROUP BY 机组
```

**数据区域2：每个机组每天的指标随着时间变化的情况**

第一个长条图：

（折线图）（选择的时间段内）展示每个机组每天的故障时间（机修，电修，自修）

```sqlite
select 日期,机修+电修+自修 from down where 日期 >= '2021.06.01' and 日期 <= '2021.06.28' and 机组 = 762
```

第二个长条图：

（折线图）（选择的时间段内）展示每个机组每天的待料时间（待料）

```sqlite
select 机组,待料 from down where 日期 >= '2021.06.27' and 日期 <= '2021.06.28' GROUP BY 机组
```

第三个长条图：

（折线图）（选择的时间段内）展示每个机组每天的换辊时间（换辊）

```sqlite
select 机组,换辊 from down where 日期 >= '2021.06.27' and 日期 <= '2021.06.28' GROUP BY 机组
```

第四个长条图：
（折线图）（选择的时间段内）展示每个机组每天的开工时间

```sqlite
select 机组,(720-(机修+电修+自修+换辊+待料)) from down where 日期 >= '2021.06.27' and 日期 <= '2021.06.28' GROUP BY 机组
```

**数据区域3：每个机组在时间段内的四种状态的柱状图和饼图（左柱状图+右饼图）**

采用复合图形的形式，有可能的话采用联动共享数据集的形式

检查这段时间有多少个机组

```sqlite
SELECT DISTINCT 机组 from down
```

查询该机组相关的五个数据，以761举例

```sqlite
SELECT sum(机修),sum(电修),sum(待料),sum(换辊),sum(自修) from down where 机组 = 761 and 日期 >= (select date('now','start of day','-30 day'))
```

**数据区域4：每个机组的停开车时间占比以及停车时间的三个原因的占比（嵌套环形图）**

返回761机组的开车时间和停车时间

```sqlite
SELECT 720*30-(sum(机修)+sum(电修)+sum(自修)+sum(机修)+sum(待料)+sum(换辊)),(sum(机修)+sum(电修)+sum(自修)+sum(机修)+sum(待料)+sum(换辊)) from down where 机组 = 761 and 日期 >= (select date('now','start of day','-30 day'))
```

返回761机组的停车时间的因素占比

```sqlite
SELECT sum(机修),sum(电修),sum(自修),sum(待料),sum(换辊) from down where 机组 = 761 and 日期 >= (select date('now','start of day','-30 day'))
```

有可能的话加在数据区域二中一行三个图，不行算了。内圈为停开机占比，外圈为停机原因占比

**新增数据区域**

必须要以单个机组的数据为单位



机组和故障种类之间的联系：

1. 单个机组的时间
2. 每种故障在时间段内各机组的占比
3. 



每个机组一张表

柱状图形式：机修，电修，自修，换辊，待料（混合柱子）

折线图形式：开机时间，停机时间

以上



### 故障表页面布局

选择时间段区域

本数据区域的故障不包括以下两种。以下两种要分开统计

| 工序 | 设备 | 故障部位 |
| ---- | ---- | -------- |
| 换型 | 换型 | 换型     |
|      |      | 锯片     |

**数据区域1：采用表格的形式总览数据（表格）**

在给定时间中，各种工序的故障总时长以及在总时长中的占比以三列列表的形式呈现

```sqlite
select 工序,sum(停车时长),(round(sum(停车时长)*1.0/(select sum(停车时长) from repair where 工序 <> '换型' and   故障部位 <> '锯片')*1.0,3))as 占总故障时间的比重 from repair where 工序 <> '换型' and   故障部位 <> '锯片' GROUP BY 工序
```

表格分为工序，故障时长，占总时长的比重

**数据区域2：各故障部位的时长占总时长的占比（矩形树图）**

用来显示工序>设备>故障部位三级的占比

先搜索工序

```
select DISTINCT 工序 from repair
```

再按照工序搜索设备

```sqlite
select 设备,sum(停车时长) from repair where 工序 = '天车' GROUP BY 设备
```

再按照设备搜索故障部位

```sqlite
select 故障部位,sum(停车时长) from repair where 工序 = '成型' and 设备 = '轴承' GROUP BY 故障部位
```

**数据区域3：显示一个班组每种故障的累计时长（柱状图）**

先搜索有几个班组，然后再根据班组循环搜索

一个柱状图显示工序前五，一个柱状图显示故障部位的前五

预计需要十多张长条图

```sqlite
select 工序,sum(停车时长) from repair where 生产线 = 761 GROUP BY 工序 ORDER BY sum(停车时长) DESC
```

**数据区域4：各机组换型，换辊专项统计（柱状图）**

每个机组一张长条图，包括换型和锯片。采用只能选一个的方法



### 产量表页面布局

数据表区域

机组  成材 吨钢 电耗 单位产量 吨备件





sheet1：日期，机组，成材率，电耗

sheet2：备件金额，当日生产

```
产量/开车时间
```

### 对比分析表页面布局

时间范围选择器 周对比和月对比选择器（影响本页面的所有表格）

2个月选择框 2个周选择框 1个机组选择框

**停机对比部分**

表格部分

表1

|       |      | 114  | 127  | 761  |
| ----- | ---- | ---- | ---- | ---- |
| 序号1 | 机修 |      |      |      |
|       | 电修 |      |      |      |
|       | 自修 |      |      |      |
| 序号2 | 机修 |      |      |      |
|       | 电修 |      |      |      |
|       | 自修 |      |      |      |

表2

|                                         |        | 114       | 127  | 761  |
| --------------------------------------- | ------ | --------- | ---- | ---- |
| 第一周/第一月                           | 维修   |           |      |      |
| 用jinja自己的<br />标号系统显示是第几周 | 开机   |           |      |      |
|                                         | 故障率 | 用jinja算 |      |      |
| 第二周/第二月                           | 维修   |           |      |      |
|                                         | 开机   |           |      |      |
|                                         | 故障率 |           |      |      |

可以自行选择要对比机电自换辊待料开机中的全部项还是某几项

柱状图部分1

每张图片只显示一个机组，通过选择框选择机组，显示机电自对比和故障率对比两张柱状图

柱状图部分2

显示总数对比 

表一总数就别后台算了，直接`{{ (1.2/1.987)|round(3, 'floor') }}`

计算总计的核心方法`{{ 100*(xph1/xph2) | round(4, 'floor') }}%`

先搜索选定范围内有多少个机组是有记录的，然后再搜数据

**故障对比部分**

选择任一 机组/工序/设备/故障部位（都可以空置或者不空置） 查看柱状图对比

只显示一张图

**产量对比部分**

选机组（可空置，那就显示总的）

显示机组的

成材率 吨钢 吨电耗 单位产量 吨备件

以上可以放在一张图中，嫌麻烦的话分开放也无所谓

|       |          | 114  | 127  | 总   |
| ----- | -------- | ---- | ---- | ---- |
| 序号1 | 产量     |      |      |      |
|       | 吨钢     |      |      |      |
|       | 吨电耗   |      |      |      |
|       | 单位产量 |      |      |      |
|       | 吨备件   |      |      |      |
| 序号2 | 产量     |      |      |      |
|       | 吨钢     |      |      |      |
|       | 吨电耗   |      |      |      |
|       | 单位产量 |      |      |      |
|       | 吨备件   |      |      |      |

各机组产量之和

成材率（暂时不写）

各个机组的设备故障率

各机组加起来磁棒元/吨

各机组加起来电机元/吨

各机组加起来轧辊元/吨

吨电耗

吨耗材











**python关于时间的包**

time datetime

如何选时间：

直接在日期选择框组件中限制可选的日期



## 数据库技术要点

**根据日期选择数据**

```sqlite
where 日期 >= ((select date('now','start of day','-30 day'))
```

注意的是，该语句返回的格式是`2021-06-02`，而我们存入表中的格式是`2021.06.02`。但这并不影响查找

**整数除法改为浮点数除法**

直接在数字后乘1.0即可

**保留小数**

```sqlite
round(102.222,2)
```

**数字形式转换**

```
cast(102.7 as int)
```

**计算两个日期之间的天数**

```
Select Cast ((JulianDay('2021-06-30')-JulianDay('2021-06-01')
```

注意，这里只能用横杠而不能用点，所以日期类最好还是用横线连接而不要用点

**在sqlite中使用if**

若a为true，则返回b，否则返回c

```
iif(a,b,c) 
```

但这个东西现在测试不知为何又无法使用了。所以可以使用

```
ifnull(a,b)
```

判断a的值是否为null，如果是的话就返回b的值

**删除表中的空格**

应该在数据录入之前就删除空格，但如果没有删除就使用以下sql语句

```
UPDATE 表名 SET 字段名=REPLACE(字段名, ' ', '')
```



